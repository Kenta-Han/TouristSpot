<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <link href="./data/stylesheet_analogy_imecs.css" rel="stylesheet" type="text/css" />
  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <!-- <link type="text/css" rel="stylesheet" href="http://code.jquery.com/ui/1.12.1/themes/cupertino/jquery-ui.min.css" /> -->
  <link href="./data/jquery_themes_cupertino_ui_kai.css" rel="stylesheet" type="text/css" />
  <script type="text/javascript" src="http://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <title>観光スポット間の関係を想起する情報の提示に関する実験</title>
  <script>
    $(function () {
    $.ajax({
      url:'./data/txt/spot.txt',
      success: function(data){
        var datam = data.split(/\r\n|\r|\n/);  // 改行コードで分割
        $('.visited').autocomplete({
          source: datam,
          autoFocus: true,
          delay: 300,
          minLength: 2
        });
      }
    })
    $.ajax({
      url:'./data/txt/area2.txt',
      success: function(data){
        var datam = data.split(/\r\n|\r|\n/);  // 改行コードで分割
        $('#area').autocomplete({
          source: datam,
          // autoFocus: true,
          delay: 300,
          minLength: 2
        });
      }
    })
  });
  </script>
</head>

<body>
  <header>
    <h1>観光スポット間の関係を想起する情報の提示に関する実験</h1>
  </header>

  <div class="main">
    <form id="form" name="form1">
      <div class="image"><img src="./data/crowdworks_id_img.png"></div>
      <h3>CrowdWorksID（必須）：
        <input type="text" id="user_id" name="user_id" maxlength="40" placeholder="CrowdWorksID" />
      </h3>

      <h3>
        <ul id="setumei">
          <li>これまで訪れたことがあり，気に入った観光スポットを4つ以上入力してください</li>
          <li>入力すると候補が表示されるので，その中から選択ください</li>
        </ul>
      </h3>

      <ol>
        <li><input type="text" class="visited" name="visited" /></li>
        <li><input type="text" class="visited" name="visited" /></li>
        <li><input type="text" class="visited" name="visited" /></li>
        <li><input type="text" class="visited" name="visited" /></li>
        <li><input type="text" class="visited" name="visited" /></li>
        <li><input type="text" class="visited" name="visited" /></li>
        <li><input type="text" class="visited" name="visited" /></li>
        <li><input type="text" class="visited" name="visited" /></li>
        <li><input type="text" class="visited" name="visited" /></li>
        <li><input type="text" class="visited" name="visited" /></li>
      </ol>

      <h3>旅行等で行ったことがなく，これから行ってみたい都道府県・エリアを入力してください</h3>
      <h3>都道府県：
        <!-- <input type="text" id="prefecture" name="prefecture" placeholder="石川" /> -->
        <select name="prefecture" id="prefecture">
          <option value="北海道">北海道</option>
          <option value="青森">青森</option>
          <option value="岩手">岩手</option>
          <option value="宮城">宮城</option>
          <option value="秋田">秋田</option>
          <option value="山形">山形</option>
          <option value="福島">福島</option>
          <option value="茨城">茨城</option>
          <option value="栃木">栃木</option>
          <option value="群馬">群馬</option>
          <option value="埼玉">埼玉</option>
          <option value="千葉">千葉</option>
          <option value="東京">東京</option>
          <option value="神奈川">神奈川</option>
          <option value="新潟">新潟</option>
          <option value="富山">富山</option>
          <option value="石川">石川</option>
          <option value="福井">福井</option>
          <option value="山梨">山梨</option>
          <option value="長野">長野</option>
          <option value="岐阜">岐阜</option>
          <option value="静岡">静岡</option>
          <option value="愛知">愛知</option>
          <option value="三重">三重</option>
          <option value="滋賀">滋賀</option>
          <option value="京都">京都</option>
          <option value="大阪">大阪</option>
          <option value="兵庫">兵庫</option>
          <option value="奈良">奈良</option>
          <option value="和歌山">和歌山</option>
          <option value="鳥取">鳥取</option>
          <option value="島根">島根</option>
          <option value="岡山">岡山</option>
          <option value="広島">広島</option>
          <option value="山口">山口</option>
          <option value="徳島">徳島</option>
          <option value="香川">香川</option>
          <option value="愛媛">愛媛</option>
          <option value="高知">高知</option>
          <option value="福岡">福岡</option>
          <option value="佐賀">佐賀</option>
          <option value="長崎">長崎</option>
          <option value="熊本">熊本</option>
          <option value="大分">大分</option>
          <option value="宮崎">宮崎</option>
          <option value="鹿児島">鹿児島</option>
          <option value="沖縄">沖縄</option>
        </select>
      </h3>

      <h3>エリア（任意）：
        <input type="text" id="area" name="area" placeholder="函館・大沼・松前" />
      </h3>
      <input type="submit" id="start" value="実験開始（結果はローディング後で表示）" />
    </form>
  </div>

  <p style="text-align:center;font-size:20px;">「実験開始」をクリックしてから，結果が表示されるまで，その間再読込を行わないでください．<br>（表示するまで最大150秒かかる場合があります，150秒過ぎると「Timeout」が表示されます．）<br>結果の未訪問スポット，キーワード，既訪問スポットが同じの場合，自動的に回答が連動します．<br><span style="color:#ff0000;">結果表示後「承認コード」をコピーして，「結果送信」をクリックしてください．</span></p>

  <form id="form_result" name="form_result">
    <!-- 相対的な特徴-調和平均 -->
    <div class="result">
      <!-- <h1>相対的な特徴（差分ベクトルー1.調和平均2.相加平均）</h1> -->
      <div class="vector_result"></div>
      <h1>承認コード：<span id="code"></span></h1>
      <!-- <input type="submit" id="finish" value="結果送信" /> -->
      <div class="fini"></div>
    </div>
  </form>

  <script type="text/javascript">
    var temp_vis = []
    //未入力チェック
    function check() {
      var flag = 0;
      var visited_list = []
      $("input[name='visited']").each(function() {
        if ($(this).val() != "") {
          visited_list.push($(this).val());
        }
      });
      temp_vis = visited_list.filter(function() {
        return $("this").val() != ""
      });

      if (document.form1.user_id.value == "") {
        flag = 1;
      } else if (temp_vis.length < 4) {
        flag = 1;
      } else if (document.form1.prefecture.value == "") {
        flag = 1;
      }

      if (flag == 1) {
        return false;
      } else {
        return true;
      }
    }
    //既訪問スポットの重複チェック
    function jyufuku() {
      var counts = {};
      for (var i = 0; i < temp_vis.length; i++) {
        var key = temp_vis[i];
        counts[key] = (counts[key]) ? counts[key] + 1 : 1;
      }

      var flag1 = []
      for (var key in counts) {
        // console.log(key + " : " + counts[key]);
        if (counts[key] == 1) {
          flag = 0
        } else {
          flag1.push(1)
        }
      }

      if (flag1.length == 0) {
        return true;
      } else {
        return false;
      }
    }
    //既訪問スポットが"---"入っているか
    function word_check() {
      var flag = 0;
      // console.log((temp_vis));
      var flag1 = []
      for (var i = 0; i < temp_vis.length; i++) {
        if (temp_vis[i].indexOf("---") != -1) { //入っている時は-1ではない
          flag = 0;
        } else {
          flag1.push(1)
        }
      }
      // console.log(flag1);
      if (flag1.length == 0) {
        return true;
      } else {
        return false;
      }
    }
    // 積集合（wordの中身をチェックするため）
    Set.prototype.intersection = function(setB) {
      var intersection = new Set();
      for (var elem of setB) {
        if (this.has(elem)) {
          intersection.add(elem);
        }
      }
      return intersection;
    }

    // response dataをhtmlで作成
    function Vector(data) {
      if (data.length == 0) {
        return "<p style='text-align:center;'>既訪問スポットと類似する未訪問スポットが見つかりませんでした．</p>"
      } else {
        var set = []
        for (var i = 0; i < data.length; i++) {
          set[i] = "<tr><td class='unv'><a href='" + data[i]["unvis_url"] + "' target='_blank'>" + data[i]["unvis_name"] + "</a></td><td class='word'>" + data[i]["word"] +
            "</td><td class='vis'>" + data[i]["vis_name"] + "</td><td class='hyouka_word'><ul class='hyouka_ul'><li><input type='radio' name='" + data[i]["unvis_name"] + " and " + data[i]["vis_name"] + "_" +
            data[i]["label"] + "：' value='1'>2つのスポットにそもそも関係性があるが，キーワードにより関係が明確になった</li><li><input type='radio' name='" + data[i]["unvis_name"] + " and " + data[i]["vis_name"] + "_" +
            data[i]["label"] + "：' value='2'>2つのスポットの関係にキーワードにより初めて気がついた</li><li><input type='radio' name='" + data[i]["unvis_name"] + " and " + data[i]["vis_name"] + "_" +
            data[i]["label"] + "：' value='3'>2つのスポットに関係性があるがキーワードは関係性を表していない<br><input type='text' name='" + data[i]["unvis_name"] + " and " + data[i]["vis_name"] + "_" +
            data[i]["label"] + "t：' placeholder='適切なキーワードを入力してください(任意)' class='hyouka_text'></li><li><input type='radio' name='" + data[i]["unvis_name"] + " and " + data[i]["vis_name"] + "_" +
            data[i]["label"] + "：' value='4'>2つのスポットに関係性はない</li></ul></td></tr>"
        }
        return "<table><tr><th>未訪問スポット</th><th>キーワード</th><th>既訪問スポット</th><th>評価</th></tr>" + set.join("") + "</table><br><h2><span style='color:#ff0000;'>入力が終わったら「承認コード」をコピーして，「結果送信」をクリックしてください．</span></h2>"
      }
    }

    var res = 0;
    var record_id = 0;
    var post_visited = [];
    var len = 0;
    // データの送信Ajax（入力内容）
    $(document).ready(function() {
      $("#form").submit(function() {
        event.preventDefault();
        if (check() == true) {
          if (jyufuku() == true) {
            if (word_check() == true) {
              var $form = $(this);
              $(".visited").each(function() {
                if ($(this).val() != "") {
                  post_visited.push($(this).val());
                }
              });
              location.href = "#form_result"
              $(".vector_result").html("<h2>Loading...</h2><div class='loader'>Loading...</div>");
              $("#start").prop("disabled", true); //ボタンクリック禁止
              window.onerror = function() {
                alert("Error：入力に問題が見つかったためもう一度入力してください．");
                location.reload();
                $(".vector_result").html("<h1>Error：入力に問題が見つかったためもう一度入力してください</h1>");
              };
              $.ajax({ //データ送信
                  url: "./cgi-bin/analogy_deim/processing.py",
                  type: "post",
                  dataType: "text",
                  data: {
                    user_id: $("#user_id").val(),
                    visited_name: post_visited,
                    prefecture_name: $("#prefecture").val(),
                    area_name: $("#area").val(),
                  },
                  timeout: 150000,
                  error: function() {
                    alert("Timeout：しばらくしてもう一度試してください")
                  },
                })
                .done(function(response) { //データを受信
                  console.log(response);
                  res = $.parseJSON(response);
                  console.log(res)
                  // res[0]はデータ，res[1]はrandom，res[2]はrecord_id
                  vector = Vector(res[0]);
                  $(".vector_result").html(vector);
                  $("#code").html(res[1]["randomname"]);
                  record_id = res[2];
                  len = res[0].length;
                  $(".fini").html("<input type='submit' id='finish' value='結果送信' />");
                })
                .fail(function() {
                  $(".result").html("Failed.");
                });
            } else {
              alert('検索候補から選んでください');
            }
          } else {
            alert('入力に重複がありました');
          }
        } else {
          alert('必須項目に未記入欄がありました');
        }
      });
    });
    // radiobuttonの連動
    $(document).on("click", "input[type='radio']", function(event) {
      var un_name = $(event.target).parent().parent().parent().parent().find('a').html();
      var vi_name = $(event.target).parent().parent().parent().parent().children('.vis').html();
      var setA = new Set($(event.target).parent().parent().parent().parent().children('.word').html().split(','));
      $('input[type="radio"]').filter(function() {
        var setB = new Set($(this).parent().parent().parent().parent().children('.word').html().split(','));
        return (($(this).parent().parent().parent().parent().find('a').html() === un_name) && ($(this).parent().parent().parent().parent().children('.vis').html() === vi_name) && (setA.intersection(setB).size === setA.size))
      }).val([$(this).val()])
    });

    // DBにinsert用データを作成
    function Insert_Data(data) {
      var hyouka = [];
      var hyouka_text = [];
      if (data.length == 0 || data.length == 1) {
        return [0, 0]
      }
      for (var i = 0; i < data.length; i++) {
        if (i == 0) {
          continue
        }
        // チェックしたradiobuttonの値を取る
        name = data.eq(i).find("input:checked").eq(0).attr("name");
        val = data.eq(i).find("input:checked").eq(0).val();
        // textに入力した値を取る
        text_name = data.eq(i).find("input:text").eq(0).attr("name");
        text_val = data.eq(i).find("input:text").eq(0).val();
        hyouka.push(name + val);
        hyouka_text.push(text_name + text_val)
      }
      // console.log(hyouka);
      // console.log(hyouka_text);
      return [hyouka, hyouka_text]
    }

    // データの送信Ajax（評価内容）
    $(document).ready(function() {
      $("#form_result").submit(function() {
        event.preventDefault();
        var $form = $(this);

        if ($(".vector_result").find("input:checked").length == len) {
          temp = $(".vector_result").find("tr");
          idata = Insert_Data(temp);

          $.ajax({ //データ送信
              url: "./cgi-bin/analogy_deim/insert_mysql.py",
              type: "post",
              dataType: "text",
              data: {
                record_id: record_id["record_id"],
                hyouka: idata[0],
                hyouka_text: idata[1],
              },
              timeout: 60000,
              error: function() {
                alert("Timeout：もう一度試してください")
              },
            })
            .done(function(response) { //データを受信
              // console.log(response);
              // res = $.parseJSON(response);
              // console.log(res);
              window.location.href = "./index.html";　// ページ遷移
            })
            .fail(function() {
              $(".result").html("Failed.");
            });
        } else {
          alert('チェックしてない内容がありました');
        }
      });
    });
  </script>
</body>

</html>
