<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <link href="../data/stylesheet_analogy_deim2020.css" rel="stylesheet" type="text/css" />
  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <link type="text/css" rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/cupertino/jquery-ui.min.css" />
  <script type="text/javascript" src="http://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <title>観光スポット説明向上の可視化地図</title>
  <script>
    $(function () {
    $.ajax({
      url:'../data/txt/spot.txt',
      success: function(data){
        var datam = data.split(/\r\n|\r|\n/);  // 改行コードで分割
        $('.visited').autocomplete({
          source: datam,
          autoFocus: true,
          delay: 300,
          minLength: 2
        });
      }
    })
    $.ajax({
      url:'../data/txt/area2.txt',
      success: function(data){
        var datam = data.split(/\r\n|\r|\n/);  // 改行コードで分割
        $('#area').autocomplete({
          source: datam,
          // autoFocus: true,
          delay: 300,
          minLength: 2
        });
      }
    })
  });
  </script>
</head>

<body>
  <div id="main_top">
    <form id="form_main" name="form_main">
      <div id="familiar">
        <h3>CrowdWorksID：
          <input type="text" id="user_id" name="user_id" maxlength="40" value="test" />
        </h3>
        <h3>
          <ul id="setumei">
            <li>これまで訪れたことがあり，気に入った観光スポットを4つ以上入力してください</li>
            <li>入力すると候補が表示されるので，その中から選択ください</li>
          </ul>
        </h3>
        <table class="visited">
          <tr>
            <td><input type="text" class="visited" name="visited" value="富士急ハイランド---山梨" /></td>
            <td><input type="text" class="visited" name="visited" value="キッザニア東京---東京" /></td>
            <td><input type="text" class="visited" name="visited" value="東京お台場　大江戸温泉物語---東京" /></td>
          </tr>
          <tr>
            <td><input type="text" class="visited" name="visited" value="しんしのつ温泉たっぷの湯---北海道" /></td>
            <td><input type="text" class="visited" name="visited" value="さっぽろテレビ塔---北海道" /></td>
            <td><input type="text" class="visited" name="visited"  /></td>
          </tr>
          <tr>
            <td><input type="text" class="visited" name="visited"  /></td>
            <td><input type="text" class="visited" name="visited" /></td>
            <td><input type="text" class="visited" name="visited" /></td>
          </tr>
        </table>
        <!-- <table class="visited">
          <tr>
            <td><input type="text" class="visited" name="visited" value="東京ドイツ村---千葉" /></td>
            <td><input type="text" class="visited" name="visited" value="富士急ハイランド---山梨" /></td>
            <td><input type="text" class="visited" name="visited" value="国営ひたち海浜公園---茨城" /></td>
          </tr>
          <tr>
            <td><input type="text" class="visited" name="visited" value="アクアパーク品川---東京" /></td>
            <td><input type="text" class="visited" name="visited" value="長崎バイオパーク---長崎" /></td>
            <td><input type="text" class="visited" name="visited" value="ハウステンボス---長崎"  /></td>
          </tr>
          <tr>
            <td><input type="text" class="visited" name="visited" value="川越氷川神社---埼玉"  /></td>
            <td><input type="text" class="visited" name="visited" value="千里浜なぎさドライブウェイ---石川" /></td>
            <td><input type="text" class="visited" name="visited" /></td>
          </tr>
        </table> -->
        <!-- <table class="visited">
          <tr>
            <td><input type="text" class="visited" name="visited" value="成田山新勝寺---千葉" /></td>
            <td><input type="text" class="visited" name="visited" value="平間寺（川崎大師）---神奈川" /></td>
            <td><input type="text" class="visited" name="visited" value="東京スカイツリー---東京" /></td>
          </tr>
          <tr>
            <td><input type="text" class="visited" name="visited" value="東京タワー大展望台---東京" /></td>
            <td><input type="text" class="visited" name="visited" value="海遊館---大阪" /></td>
            <td><input type="text" class="visited" name="visited" value="沖縄美ら海水族館---沖縄" /></td>
          </tr>
          <tr>
            <td><input type="text" class="visited" name="visited" value="新宿御苑---東京" /></td>
            <td><input type="text" class="visited" name="visited" /></td>
            <td><input type="text" class="visited" name="visited" /></td>
          </tr>
        </table> -->
        <!-- <table class="visited">
          <tr>
            <td><input type="text" class="visited" name="visited" value="富士急ハイランド---山梨" /></td>
            <td><input type="text" class="visited" name="visited" value="ユニバーサル・スタジオ・ジャパン（USJ）---大阪" /></td>
            <td><input type="text" class="visited" name="visited" value="高千穂神社（十社大明神）---宮崎" /></td>
          </tr>
          <tr>
            <td><input type="text" class="visited" name="visited" value="天岩戸神社---宮崎" /></td>
            <td><input type="text" class="visited" name="visited" value="阿蘇中岳火口（阿蘇山上）---熊本" /></td>
            <td><input type="text" class="visited" name="visited" value="富士山---山梨" /></td>
          </tr>
          <tr>
            <td><input type="text" class="visited" name="visited" value="新宿御苑---東京" /></td>
            <td><input type="text" class="visited" name="visited" /></td>
            <td><input type="text" class="visited" name="visited" /></td>
          </tr>
        </table> -->
      </div>
      <div id="unfamiliar">
        <img src="../data/crowdworks_id_img.png" style="width:20%;"></img>
        <h3>これから行ってみたい都道府県・エリアを入力してください</h3>

        <h3>都道府県：
          <select name="prefecture" id="prefecture">
            <option value="京都">京都</option>
            <option value="東京">東京</option>
            <option value="北海道">北海道</option>
            <option value="青森">青森</option>
            <option value="岩手">岩手</option>
            <option value="宮城">宮城</option>
            <option value="秋田">秋田</option>
            <option value="山形">山形</option>
            <option value="福島">福島</option>
            <option value="茨城">茨城</option>
            <option value="栃木">栃木</option>
            <option value="群馬">群馬</option>
            <option value="埼玉">埼玉</option>
            <option value="千葉">千葉</option>
            <option value="神奈川">神奈川</option>
            <option value="新潟">新潟</option>
            <option value="富山">富山</option>
            <option value="石川">石川</option>
            <option value="福井">福井</option>
            <option value="山梨">山梨</option>
            <option value="長野">長野</option>
            <option value="岐阜">岐阜</option>
            <option value="静岡">静岡</option>
            <option value="愛知">愛知</option>
            <option value="三重">三重</option>
            <option value="滋賀">滋賀</option>
            <option value="大阪">大阪</option>
            <option value="兵庫">兵庫</option>
            <option value="奈良">奈良</option>
            <option value="和歌山">和歌山</option>
            <option value="鳥取">鳥取</option>
            <option value="島根">島根</option>
            <option value="岡山">岡山</option>
            <option value="広島">広島</option>
            <option value="山口">山口</option>
            <option value="徳島">徳島</option>
            <option value="香川">香川</option>
            <option value="愛媛">愛媛</option>
            <option value="高知">高知</option>
            <option value="福岡">福岡</option>
            <option value="佐賀">佐賀</option>
            <option value="長崎">長崎</option>
            <option value="熊本">熊本</option>
            <option value="大分">大分</option>
            <option value="宮崎">宮崎</option>
            <option value="鹿児島">鹿児島</option>
            <option value="沖縄">沖縄</option>
          </select>
        </h3>

        <h3>エリア(任意)：
          <input type="text" id="area" name="area" placeholder="函館・大沼・松前" value="天橋立・宮津・舞鶴" />
        </h3>
      </div>
      <p style="text-align:center;font-size:20px; clear:both;">「実験開始」をクリックしてから，結果が表示されるまで，その間再読込を行わないでください．</p>
      <input type="submit" id="start" value="実験開始" />
    </form>
    <div class="cluster_result" id="cluster_result" style="text-align: center;" hidden></div>
    <form id="form_cluster" name="form_cluster" hidden>
    </form>
  </div>

  <div class="loading" id="loading" style="text-align: center;" hidden></div>

  <div id="result_line" hidden>
    <h2 id="map_line_title">↓ Line_Map ↓</h2>
    <h3 id="color"><img src="../data/sti/color3.png" ></img></h3>
    <div id="map_line">
      <iframe src="https://www.google.com/maps/embed?pb=!1m16!1m12!1m3!1d13271.045898004142!2d139.69292184601608!3d35.690589482984!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!2m1!1z5bel5a2m6Zmi5aSn5a2m!5e0!3m2!1sja!2sjp!4v1541602248205" width="100%" height="100%" frameborder="0" style="border:0" allowfullscreen></iframe>
    </div>
    <div id="right">
      <h2 id="map_line_title">Line_Map</h2>
      <ul>
        <li>赤いピン：未訪問エリア内のスポット</li><p>赤いピンをクリックすると詳細情報が表示されます．<br>詳細情報は，対象のスポット名と，既訪問スポット名，対象スポットと既訪問スポットの関係を表現するキーワードです．関係性が低いとキーワードが「なし」と表示されます．</p>
        <li>黒いピン：入力した既訪問スポット</li>
        <li>カラーマップ：</li><p>カラーマップは赤いピンと黒いピンの類似度（似ている度合い）を示しています．</p>
        <p>緑色は既訪問スポットと未訪問スポットの類似度が低いこと意味します．<br>赤色は既訪問スポットと未訪問スポットの類似度が高いこと意味します．</p>
        <li>「既訪問スポット意味座標(非表示/表示)」ボタン：</li><p>黒いピンの非表示/表示を切り替えることができます．黒いピンの表示時に，赤いピンクリックするとピン同士の類似度を示す線が表示されます．</p>
      </ul>
      <p style="text-align:center; font-size:16px;">行きたいと感じた赤いピンのスポット名1つを入力：<br><input type="text" id="next_l_text"></p>
      <input type="button" id="next_l" value="次へ" >
    </div>
  </div>

  <div id="main_last" hidden>
    <!-- <h2 style='margin:20% auto 0; text-align:center;'>承認コード：<span id="code"></span></h2> -->
    <h1 class='title' style='margin:20% auto; text-align:center;'>承認コード：<span id="code"></span><br>実験にご協力頂きありがとうございました．</h1>
  </div>

  <script type="text/javascript">
    var temp_vis = [];
    //未入力チェック
    function check() {
      var flag = 0;
      var visited_list = [];
      $("input[name='visited']").each(function() {
        if ($(this).val() != "") {
          visited_list.push($(this).val());
        }
      });
      temp_vis = visited_list.filter(function() {
        return $("this").val() != ""
      });

      if (document.form_main.user_id.value == "") {
        flag = 1;
      } else if (temp_vis.length < 4) {
        flag = 1;
      } else if (document.form_main.prefecture.value == "") {
        flag = 1;
      }

      if (flag == 1) {
        return false;
      } else {
        return true;
      }
    }
    //既訪問スポットの重複チェック
    function jyufuku() {
      var counts = {};
      for (var i = 0; i < temp_vis.length; i++) {
        var key = temp_vis[i];
        counts[key] = (counts[key]) ? counts[key] + 1 : 1;
      }

      var flag1 = []
      for (var key in counts) {
        // console.log(key + " : " + counts[key]);
        if (counts[key] == 1) {
          flag = 0
        } else {
          flag1.push(1)
        }
      }

      if (flag1.length == 0) {
        return true;
      } else {
        return false;
      }
    }
    //既訪問スポットが"---"入っているか
    function word_check() {
      var flag = 0;
      // console.log((temp_vis));
      var flag1 = [];
      for (var i = 0; i < temp_vis.length; i++) {
        if (temp_vis[i].indexOf("---") != -1) { //入っている時は-1ではない
          flag = 0;
        } else {
          flag1.push(1);
        }
      }
      if (flag1.length == 0) {
        return true;
      } else {
        return false;
      }
    }
    // 積集合（wordの中身をチェックするため）
    Set.prototype.intersection = function(setB) {
      var intersection = new Set();
      for (var elem of setB) {
        if (this.has(elem)) {
          intersection.add(elem);
        }
      }
      return intersection;
    }

    // Mapのラベル座標を計算するため
    function F (n) {
      if ( n === 0 || n === 1 ) {
        return 18;
      } else if (n < 10) {
        return 50;
      } else {
        return n*2+F(n-1);
      }
    }
    // マップ作成 Start
    var map_L, bounds_L;
    var unvis_markerLatLng_L, vis_markerLatLng_L ;
    var unvis_marker_L = [], vis_marker_L = [];
    var unvis_infoWindow_L = [], vis_infoWindow_L = [];
    var infoLines_L = [];
    var markerData_L;
    var currentInfoWindow_L = null;
    var currentInfoWindow_L2 = null;
    var currentInfoLines_L = [];
    function initMap_Line(data) {
      markerData_L = data;
      map_L = new google.maps.Map(document.getElementById("map_line"));
      bounds_L = new google.maps.LatLngBounds();
      insert_unvis_marker_Line();
      insert_vis_unvis_marker_Line();
      var removeButtonDiv = document.createElement("div");
      var removeButton = new remove_ButtonControl_Line(removeButtonDiv,map_L);
      removeButtonDiv.index = 1;
      map_L.controls[google.maps.ControlPosition.TOP_CENTER].push(removeButtonDiv);
    }
    function unvis_markerEvent_Line(i,markerData){
      unvis_marker_L[i].addListener("click", function() { // マーカーをクリックしたとき
        if (currentInfoWindow_L2 != null && currentInfoWindow_L == null) {
          currentInfoWindow_L2.close();
        }
        else if (currentInfoWindow_L2 != null && currentInfoWindow_L != null){
          currentInfoWindow_L2.close();
          currentInfoWindow_L.close();
        }
        unvis_infoWindow_L[i].open(map_L, unvis_marker_L[i]); // 吹き出しの表示
        currentInfoWindow_L2 = unvis_infoWindow_L[i];
      });
    }
    function markerEvent_Line(i,markerData) {
      vis_marker_L[i].addListener("click", function() { // マーカーをクリックしたとき
        if (currentInfoWindow_L) {
          currentInfoWindow_L.close();
        } // 別の吹き出しを開くとき，前の吹き出しが自動に閉じる
        vis_infoWindow_L[i].open(map_L, vis_marker_L[i]); // 吹き出しの表示
        currentInfoWindow_L = vis_infoWindow_L[i];
      });

      unvis_marker_L[i].addListener("click", function() { // マーカーをクリックしたとき
        if (currentInfoWindow_L) {
          currentInfoWindow_L.close();
          for (var k = 0; k < currentInfoLines_L.length;k++){
            currentInfoLines_L[k].setMap(null);
          }
        } // 別の吹き出しを開くとき，前の吹き出しが自動に閉じる
        unvis_infoWindow_L[i].open(map_L, unvis_marker_L[i]); // 吹き出しの表示
        for (var k = 0; k < markerData_L.length; k++){
          vis_marker_L[k].setZIndex(0);
          if ((infoLines_L[i].getPath().getArray()[0].lat() === infoLines_L[k].getPath().getArray()[0].lat()) && (infoLines_L[i].getPath().getArray()[0].lng() === infoLines_L[k].getPath().getArray()[0].lng())) {
            infoLines_L[k].setMap(map_L);
            vis_marker_L[k].setZIndex(1000);
            currentInfoLines_L.push(infoLines_L[k]);
          }
        }
        currentInfoWindow_L = unvis_infoWindow_L[i];
      });
    }
    function insert_unvis_marker_Line(){
      // マーカー毎の処理
      for (var i = 0; i < markerData_L.length; i++) {
        unvis_markerLatLng_L = new google.maps.LatLng({
          lat: Number(markerData_L[i]["unvis_lat"]),
          lng: Number(markerData_L[i]["unvis_lng"])
        }); // 緯度経度のデータ作成

        unvis_marker_L[i] = new google.maps.Marker({ // マーカーの追加
          position: unvis_markerLatLng_L, // マーカーを立てる位置を指定
          map: map_L, // マーカーを立てる地図を指定
        });
        bounds_L.extend(unvis_marker_L[i].position);

        if ((Math.sign(markerData_L[i]["cossim"]) == -1) || (markerData_L[i]["cossim"] == 0)){
          markerData_L[i]["word"] = "なし";
        }
        var table_L = "<h2 style='text-align:center;'><a href = '" + markerData_L[i]["unvis_url"] + "'target='_blank'>" + markerData_L[i]["unvis_name"] + "</a></h2><table border='1' id='window2'><tr><th>既訪問スポット名</th><th>関係を表現するキーワード</th></tr>"
        for (var j = 0; j < markerData_L.length; j++){
          if (markerData_L[i]["unvis_name"] == markerData_L[j]["unvis_name"]){
            table_L += "<tr><td>" + markerData_L[j]["vis_name"] + "</td><td>" + markerData_L[j]["word"] + "</td></tr>"
          }
        }
        table_L = table_L + "</tsable>"
        unvis_infoWindow_L[i] = new google.maps.InfoWindow({ // 吹き出しの追加
          content: table_L,
        });
        unvis_markerEvent_Line(i,markerData_L); // マーカーにクリックイベントを追加
      }
    }
    function insert_vis_unvis_marker_Line(){
      // マーカー毎の処理
      for (var i = 0; i < markerData_L.length; i++) {
        unvis_markerLatLng_L = new google.maps.LatLng({
          lat: Number(markerData_L[i]["unvis_lat"]),
          lng: Number(markerData_L[i]["unvis_lng"])
        }); // 緯度経度のデータ作成
        vis_markerLatLng_L = new google.maps.LatLng({
          lat: Number(markerData_L[i]["vis_lat"]),
          lng: Number(markerData_L[i]["vis_lng"])
        }); // 緯度経度のデータ作成

        unvis_marker_L[i] = new google.maps.Marker({ // マーカーの追加
          position: unvis_markerLatLng_L, // マーカーを立てる位置を指定
          map: map_L, // マーカーを立てる地図を指定
        });
        vis_marker_L[i] = new MarkerWithLabel({ // マーカーの追加
          position: vis_markerLatLng_L, // マーカーを立てる位置を指定
          map: map_L, // マーカーを立てる地図を指定
          icon:{
            url:"../data/icon/spot_marker9.png",
            scaledSize: new google.maps.Size(60, 45) //サイズ
          },
          text: markerData_L[i]["vis_name"],
          labelContent: markerData_L[i]["vis_name"], //ラベル文字
          labelAnchor: new google.maps.Point(F(markerData_L[i]["vis_name"].length),0), //文字基点
          labelClass: 'labels',                        //CSSのクラス名
          labelStyle: {opacity: 0.8}   //スタイル定義
        });
        bounds_L.extend(unvis_marker_L[i].position);
        bounds_L.extend(vis_marker_L[i].position);

        if ((Math.sign(markerData_L[i]["cossim"]) == -1) || (markerData_L[i]["cossim"] == 0)){
          markerData_L[i]["word"] = "なし";
        }
        var table_L = "<h2 style='text-align:center;'><a href = '" + markerData_L[i]["unvis_url"] + "'target='_blank'>" + markerData_L[i]["unvis_name"] + "</a></h2><table border='1' id='window2'><tr><th>既訪問スポット名</th><th>関係を表現するキーワード</th></tr>"
        for (var j = 0; j < markerData_L.length; j++){
          if (markerData_L[i]["unvis_name"] == markerData_L[j]["unvis_name"]){
            table_L += "<tr><td>" + markerData_L[j]["vis_name"] + "</td><td>" + markerData_L[j]["word"] + "</td></tr>"
          }
        }
        table_L = table_L + "</table>"
        unvis_infoWindow_L[i] = new google.maps.InfoWindow({ // 吹き出しの追加
          content: table_L,
        });
        vis_infoWindow_L[i] = new google.maps.InfoWindow({ // 吹き出しの追加
          content: "<h2 style='text-align:center; font-size:22px;'>" + markerData_L[i]["vis_name"] +
         "</h2>",
        });

        infoLines_L[i] = new google.maps.Polyline({
          path: [unvis_markerLatLng_L,vis_markerLatLng_L],
          strokeColor: markerData_L[i]["color"],
          strokeWeight: 7, // cossim * 20にする
        });
        markerEvent_Line(i,markerData_L); // マーカーにクリックイベントを追加
      }
    }
    function insert_ButtonControl_Line(buttonDiv,removebuttonUI) {
      removebuttonUI.style.display = "none";
      var buttonUI = document.createElement("div");
      buttonUI.style.backgroundColor = "#000066";
      buttonUI.style.border = "2px solid #000066";
      buttonUI.style.boxShadow = "6px 6px 3px #666666";
      buttonUI.style.cursor = "pointer";
      buttonUI.style.padding = "3px 17px";
      buttonUI.style.hober = "3px 17px";

      buttonUI.style.color = "#ffffff";
      buttonUI.style.fontFamily = "Roboto, Arial,sans-serif";
      buttonUI.style.fontSize = "18px";
      buttonUI.style.textAlign = "center";

      buttonUI.title = "既訪問スポット意味座標表示";
      buttonUI.innerHTML = "既訪問スポット意味座標表示";
      buttonDiv.style.padding = "5px";
      buttonDiv.appendChild(buttonUI);

      google.maps.event.addDomListener(buttonUI,"mouseover", function() {
        buttonUI.style.backgroundColor = "#ffffff";
        buttonUI.style.boxShadow = "none";
        buttonUI.style.color = "#000066";
        google.maps.event.addDomListener(buttonUI,'mouseout', function() {
            if(buttonUI.style.backgroundColor = "#ffffff"){
                buttonUI.style.backgroundColor = "#000066";
                buttonUI.style.boxShadow = "6px 6px 3px #666666";
                buttonUI.style.color = "#ffffff";
            }
        });
      });

      google.maps.event.addDomListener(buttonUI, "click", function() {
        removebuttonUI.style.display = "block";
        buttonUI.style.display = "none";
        insert_unvis_marker_Line();
        insert_vis_unvis_marker_Line();
      });
    }
    function remove_ButtonControl_Line(buttonDiv) {
      var buttonUI = document.createElement("div");
      buttonUI.style.backgroundColor = "#000066";
      buttonUI.style.border = "2px solid #000066";
      buttonUI.style.boxShadow = "6px 6px 3px #666666";
      buttonUI.style.cursor = "pointer";
      buttonUI.style.padding = "3px 17px";
      buttonUI.style.hober = "3px 17px";

      buttonUI.style.color = "#ffffff";
      buttonUI.style.fontFamily = "Roboto, Arial,sans-serif";
      buttonUI.style.fontSize = "18px";
      buttonUI.style.textAlign = "center";

      buttonUI.title = "既訪問スポット意味座標非表示";
      buttonUI.innerHTML = "既訪問スポット意味座標非表示";
      buttonDiv.style.padding = "5px";
      buttonDiv.appendChild(buttonUI);

      google.maps.event.addDomListener(buttonUI,"mouseover", function() {
        buttonUI.style.backgroundColor = "#ffffff";
        buttonUI.style.boxShadow = "none";
        buttonUI.style.color = "#000066";
        google.maps.event.addDomListener(buttonUI,'mouseout', function() {
            if(buttonUI.style.backgroundColor = "#ffffff"){
                buttonUI.style.backgroundColor = "#000066";
                buttonUI.style.boxShadow = "6px 6px 3px #666666";
                buttonUI.style.color = "#ffffff";
            }
        });
      });

      google.maps.event.addDomListener(buttonUI, "click", function() {
        delete_vis_Makers_Line();
        delete_unvis_Makers_Line();
        delete_line_Makers_Line();
        var insertButtonDiv = document.createElement("div");
        var insertButton = new insert_ButtonControl_Line(insertButtonDiv, buttonUI);
        insertButtonDiv.index = 1;
        map_L.controls[google.maps.ControlPosition.TOP_CENTER].push(insertButtonDiv);
      });
    }
    function delete_vis_Makers_Line() {
      if(vis_marker_L.length != 0){
        for (var i = 0; i < vis_marker_L.length; i++) {
          vis_marker_L[i].setMap(null);
        }
      }
    }
    function delete_unvis_Makers_Line() {
      if(unvis_marker_L.length != 0){
        for (var i = 0; i < unvis_marker_L.length; i++) {
          unvis_marker_L[i].setMap(null);
        }
      }
    }
    function delete_line_Makers_Line() {
      if(infoLines_L.length != 0){
        for (var i = 0; i < infoLines_L.length; i++) {
          infoLines_L[i].setMap(null);
        }
      }
    }
    // マップ作成 Finish

    var post_visited = [];
    var res;
    // データの送信Ajax
    $(document).ready(function() {
      $("#form_main").submit(function() {
        event.preventDefault();
        if (check() == true) {
          if (jyufuku() == true) {
            if (word_check() == true) {
              var $form = $(this);
              $(".visited").each(function() {
                if ($(this).val() != "") {
                  post_visited.push($(this).val());
                }
              });
              document.getElementById("form_main").style.display="none";
              document.getElementById("cluster_result").style.display="block";
              // location.href = "#cluster_result"
              $(".cluster_result").html("<p style='text-align:center;font-size:22px; clear:both;'>表示するまで最大2分かかる場合があります．<br>「Timeout」が表示された場合，再読込を行なってください．</p><img src='./data/loading4.gif' style='width:30%'></img>");
              window.onerror = function() {
                alert("Error：入力に問題が見つかったため，異なるスポットを入力して，もう一度やり直してください．");
                // location.reload();
              };
              $.ajax({
                  url: "../cgi-bin/analogy_deim2020_2/processing.py",
                  type: "post",
                  dataType: "text",
                  data: {
                    user_id: $("#user_id").val(),
                    visited_name: post_visited,
                    prefecture_name: $("#prefecture").val(),
                    area_name: $("#area").val(),
                  },
                  timeout: 420000, // 7分
                  error: function() {
                    alert("Timeout：時間を空けて，もう一度試してください．")
                  },
                })
                .done(function(response) { //データを受信
                  console.log(response);
                  res = $.parseJSON(response); //受信データをjsonに変換
                  console.log(res);
                  // console.log(typeof res);
                  if (res["word"].length == 1) {
                    $(".cluster_result").html("<h2>Search Results：合致するスポット情報は見つかりませんでした．<br>異なるスポットを入力して，もう一度試してください．</h2><h3><a href='http://127.0.0.1:8000/analogy_deim2020_2.html'>実験ページへ</a></h3>");
                  } else {
                    document.getElementById("cluster_result").style.display="none";
                    var table_st = $("<table border='1' style='width:80%;'><tr><th style='width:10%;'>番号</th><th>内容</th></tr>");
                    for (var r = 1; r <= res["word"].length; r++) {
                        tmp = $("<tr><td><input type='radio' name='cluster' value='" + res["word"][r-1][0] + "'> " + r + "</td><td class='cluster'>" + res["word"][r-1][1].join("，") + "</td></tr>")
                        table_st.append(tmp)
                    }
                    var table_end = $("</table>")
                    $('#form_cluster').append(table_st.append(table_end));
                    $('#form_cluster').append("<input type='submit' id='search' value='検索' >")
                    document.getElementById("form_cluster").style.display="block";
                  }
                })
                .fail(function() {
                  $(".cluster_result").html("Failed.");
                });
            } else {
              alert('検索候補から選んでください．');
            }
          } else {
            alert('入力に重複がありました．');
          }
        } else {
          alert('必須項目に未記入欄がありました．');
        }
      });
    });
    $(document).ready(function() {
      $("#form_cluster").submit(function() {
        event.preventDefault();
        // radionbutton入力チェック
        var element = document.getElementById("form_cluster") ;
        var radioNodeList = element.cluster;
        var choice_value_data = radioNodeList.value ;
        if (choice_value_data.length != 0){
          console.log(res);
          // console.log(choice_value_data);
          // console.log(typeof res["tfidf_dataset"]);
          // ajaxのためにres["tfidf_dataset"]を整形
          // var tfidf_dataset = [];
          // for(i=0;i<res["tfidf_dataset"].length;i++){
          //   tfidf_dataset.push(res["tfidf_dataset"][i][0]);
          //   for(j=0;j<res["tfidf_dataset"][i][1].length;j++){
          //     tfidf_dataset.push(res["tfidf_dataset"][i][1][j][0]);
          //     tfidf_dataset.push(res["tfidf_dataset"][i][1][j][1]);
          //   }
          //   tfidf_dataset.push("-finish-");
          // }
          // ajaxのためにres["vis_score_dic"]を整形
          document.getElementById("main_top").style.display="none";
          document.getElementById("loading").style.display="block";
          var vis_scoreset = [];
          for(i=0;i<res["vis_score_dic"].length;i++){
            vis_scoreset.push(res["vis_score_dic"][i][0]);
            vis_scoreset.push(res["vis_score_dic"][i][1]);
            for(j=0;j<res["vis_score_dic"][i][2].length;j++){
              vis_scoreset.push(res["vis_score_dic"][i][2][j]);
            }
            vis_scoreset.push("-finish-");
          }
          // ajaxのためにres["vis_center_use"]を整形
          // var vis_centerset = [];
          // for(i=0;i<res["vis_center_use"].length;i++){
          //   vis_centerset.push(res["vis_center_use"][i][0]);
          //   for(j=0;j<res["vis_center_use"][i][1].length;j++){
          //     vis_centerset.push(res["vis_center_use"][i][1][j]);
          //   }
          //   vis_centerset.push("-finish-");
          // }
          console.log(choice_value_data);

          $(".loading").html("<p style='text-align:center;font-size:22px; clear:both;'>表示するまで最大10分かかる場合があります．<br>「Timeout」が表示された場合，再読込を行なってください．</p><img src='./data/loading4.gif' style='width:30%'></img>");
          window.onerror = function() {
            alert("Error：問題が見つかったため，もう一度やり直してください．");
            // location.reload();
          };
          $.ajax({
              url: "../cgi-bin/analogy_deim2020_2/processing2.py",
              type: "post",
              dataType: "text",
              data: {
                record_id: res["record_id"],
                choice: choice_value_data, //選択クラスタ番号
                visited_name: post_visited, //既訪問スポット
                vis_score: vis_scoreset,
                // tfidf_vis_data: tfidf_dataset,
                // vis_center: vis_centerset,
              },
              timeout: 600000, // 10分 = 60 * 10 * 1000
              error: function() {
                alert("Timeout：時間を空けて，もう一度試してください．")
              },
            })
            .done(function(response) { //データを受信
              console.log(response);
              res = $.parseJSON(response); //受信したデータをjson形式に変更
              console.log(res);
              document.getElementById("loading").style.display="none";
              if (res.length == 0) {
                $(".loading").html("<h2>Search Results：合致するスポット情報は見つかりませんでした．</h2>");
              } else {
                $(".vector_result").html("");
                initMap_Line(res[0]);
                document.getElementById("result_line").style.display="block";
                map_L.fitBounds(bounds_L);
                $("#code").html(res[1]["randomname"]);
              }
            })
            .fail(function() {
              $(".loading").html("Failed.");
            });
        } else {
          alert('結果を1つ選んでください．');
        }
      });
    });
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?v=3&key=AIzaSyBzLtrdLAR0doAuGVk0HDIRkZJ1CkmDelo"></script>
  <script src="../data/markerwithlabel.js"></script>
</body>

</html>
