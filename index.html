<!DOCTYPE html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <link href='/data/new_stylesheet.css' rel='stylesheet' type='text/css' />
  <title>観光スポット検索</title>
</head>

<body>
  <header>
    <h1 class='title'>観光スポット検索</h1>
  </header>
  <div class='left'>
    <form id='form'>
      <h3 class='crowdworks_id'>ユーザ名：<input type='text' name='user_id' id='user_id' maxlength='40' style='width: 200px;height: 24px;font-size:16px;' /></h3>
      <p style='text-align:center;'>行ったことがあるスポット名の入力をお願いします</p>
      <h3 class='keyword'><textarea name='history_name' style='width:350px; height:150px; font-size:14px;' /></textarea></h3>
      <p style='text-align:center;'>観光エリアの入力をお願いします</p>
      <h3 class='keyword'>都道府県：<input type='text' id='prefecture_name' style='width:250px; height:24px; font-size:16px;' /></h3>
      <h3 class='keyword'>エリア：<input type='text' id='area_name' style='width:250px; height:24px; font-size:16px;' /></h3>

      <p style='color:#ff0000'>全ての項目の入力し終えたら，「実験開始」をクリックしてください．</p>
      <input type='submit' class="button1" value='実験開始' />
    </form>
  </div>

  <div class='right'>
    <h2 style='color:red;'>注意事項！！</h2>
    <h3>== CrowdWorksIDについて ==</h3>
    <div class='image'><img src='../../data/crowdworks_id_img.png'></div>
    <h3>== 都道府県の入力に関して ==</h3>
    <p style="color:red;">◯良い例：東京，大阪，京都，神奈川，北海道</p>
    <p>×悪い例：東京都，大阪府，京都府，神奈川県</p>
  </div>

  <div id="result" style="clear:both;">
    <br><div id="map" style="width:100%; height:750px; margin: 0 8px 0 8px;"></div>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzLtrdLAR0doAuGVk0HDIRkZJ1CkmDelo&callback=initMap"></script>
  </div>

  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <script type="text/javascript">
    $(document).ready(function() {
      $('#form').submit(function() {
        event.preventDefault();
        var $form = $(this);
        $.ajax({
            url: 'http://127.0.0.1:8000/cgi-bin/visited_map/sample.py',
            type: 'post',
            dataType: 'text',
            data: {
              user_id: $('#user_id').val(),
              history_name: $('#history_name').val(),
              prefecture_name: $('#prefecture_name').val(),
              area_name: $('#area_name').val()
            },
          })
          .done(function(response) {
            // $('#result').html(response);
            var res = $.parseJSON(response)
            $('#result').html(res[0]["unvis_name"]);
            var map;
            var marker = [];
            var infoWindow = [];
            var markerData = res;
            // データを受け取る
            function getdata(){
              var marker = document.getElementById('num').value;
              numx = parseInt(x);
              numx = numx + 1;
              document.getElementById('answer').innerHTML = numx;
            }
            function initMap(){
              console.log(res);
              // 地図の作成
              var mapLatLng = new google.maps.LatLng({
                lat: markerData[0]['unvis_lat'],
                lng: markerData[0]['unvis_lng']
              }); // 緯度経度のデータ作成
              map = new google.maps.Map(document.getElementById('map'), { // #mapに地図を埋め込む
                center: mapLatLng, // 地図の中心を指定
                zoom: 15 // 地図のズームを指定
              });

              // マーカー毎の処理
              for (var i = 0; i < markerData.length; i++) {
                markerLatLng = new google.maps.LatLng({
                  lat: markerData[i]['unvis_lat'],
                  lng: markerData[i]['unvis_lng']
                }); // 緯度経度のデータ作成
                marker[i] = new google.maps.Marker({ // マーカーの追加
                  position: markerLatLng, // マーカーを立てる位置を指定
                  map: map // マーカーを立てる地図を指定
                });

                infoWindow[i] = new google.maps.InfoWindow({ // 吹き出しの追加
                  // 吹き出しに表示する内容
                  content: '<div class="sample">' + markerData[i]['unvis_name'] + '<br>' + markerData[i]['word'] + '</div>'
                });
                markerEvent(i); // マーカーにクリックイベントを追加
              }
            }
            // マーカーにクリックイベントを追加
            function markerEvent(i) {
              marker[i].addListener('click', function() { // マーカーをクリックしたとき
                infoWindow[i].open(map, marker[i]); // 吹き出しの表示
              });
            }
          })
          .fail(function() {
            $('#result').html('Failed.');
          });
      });
    });
  </script>
</body>

</html>
